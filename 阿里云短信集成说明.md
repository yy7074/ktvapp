# KTV预约系统 - 阿里云短信集成说明

## 📱 短信服务配置

### 阿里云账户信息
- **AccessKey ID**: `LTAI5tAgxEfwZrWw1sSpm9qF`
- **AccessKey Secret**: `WpZgkZH9eNLdtc7deUiGzU7gqp5uRK`
- **短信签名**: `大潮网络`
- **短信模板**: `SMS_474780238`
- **区域**: `cn-hangzhou`

### 短信模板内容
验证码模板：`您的验证码是${code}，5分钟内有效，请勿泄露给他人。`

## 🔧 技术实现

### 集成方式
采用**HTTP API直接调用**方式，无需安装复杂的SDK，兼容性更好。

### 核心文件
1. **`aliyun_sms_simple.php`** - 阿里云短信API封装类
2. **`send_code.php`** - 发送验证码接口（已集成短信功能）
3. **`login.php`** - 登录接口（已集成验证码验证）
4. **`test_sms_simple.php`** - 短信功能测试脚本

## 🚀 功能特性

### 短信发送限制
- **发送间隔**: 60秒内只能发送一次
- **每日限制**: 每个手机号每天最多10条
- **验证码有效期**: 5分钟
- **验证码长度**: 6位数字

### 安全机制
- 验证码一次性使用（验证后自动失效）
- 过期自动失效
- 频率限制防止恶意刷取
- 错误日志记录

## 📋 测试结果

### 最新测试
```
测试手机号: 18663764585
短信签名: 大潮网络
短信模板: SMS_474780238

✅ 阿里云短信客户端初始化成功
✅ 发送频率检查通过
📱 生成验证码: 107638
✅ 验证码已保存到数据库
📤 正在发送短信...
✅ 短信发送成功!
   RequestId: 76528858-0C8A-5D1F-A2FD-9FC4D90C395A
   消息: 短信发送成功
```

## 🔄 使用流程

### 前端调用流程
1. 用户输入手机号
2. 点击"获取验证码"按钮
3. 前端调用 `POST /send_code.php`
4. 用户收到短信验证码
5. 输入验证码后调用 `POST /login.php`
6. 验证成功后返回用户信息和token

### API调用示例

#### 发送验证码
```javascript
// 前端调用示例
uni.request({
    url: 'http://catdog.dachaonet.com/send_code.php',
    method: 'POST',
    data: {
        phone: '18663764585'
    },
    success(res) {
        if (res.data.success) {
            console.log('验证码发送成功');
        } else {
            console.log('发送失败:', res.data.message);
        }
    }
});
```

#### 验证登录
```javascript
// 前端调用示例
uni.request({
    url: 'http://catdog.dachaonet.com/login.php',
    method: 'POST',
    data: {
        phone: '18663764585',
        code: '107638'
    },
    success(res) {
        if (res.data.success) {
            // 登录成功，保存用户信息
            uni.setStorageSync('userInfo', res.data.data.user);
            uni.setStorageSync('token', res.data.data.token);
        } else {
            console.log('登录失败:', res.data.message);
        }
    }
});
```

## 🌐 域名访问配置

### 公网访问
后端已配置为通过域名 `catdog.dachaonet.com` 访问本地3000端口：

```bash
# 启动公网访问模式
./start-backend-public.sh
```

### 前端配置
前端已配置为使用域名访问，无需修改。小程序和App可以直接通过域名调用API。

## 🔍 测试方法

### 1. 命令行测试
```bash
cd ktv-api
php test_sms_simple.php
```

### 2. API接口测试
```bash
# 发送验证码
curl -X POST http://catdog.dachaonet.com/send_code.php \
  -H "Content-Type: application/json" \
  -d '{"phone":"18663764585"}'

# 验证登录
curl -X POST http://catdog.dachaonet.com/login.php \
  -H "Content-Type: application/json" \
  -d '{"phone":"18663764585","code":"123456"}'
```

### 3. 前端测试
在uni-app中直接使用登录功能，输入手机号 `18663764585`，点击获取验证码即可收到真实短信。

## 📊 监控与日志

### 错误日志
所有短信发送错误都会记录到PHP错误日志中：
```bash
tail -f /var/log/php_errors.log
```

### 数据库记录
验证码发送记录保存在 `verification_codes` 表中，包括：
- 手机号
- 验证码
- 发送时间
- 过期时间
- 使用状态

## ⚠️ 注意事项

### 1. 流控限制
- 阿里云短信有天级流控限制（通常每天40-100条）
- 超出限制会返回 `isv.BUSINESS_LIMIT_CONTROL` 错误
- 建议在阿里云控制台调整流控策略

### 2. 模板审核
- 短信签名和模板需要在阿里云控制台审核通过
- 当前使用的签名和模板已通过审核

### 3. 成本控制
- 短信按条收费，建议设置合理的发送限制
- 当前配置：每人每天最多10条，60秒间隔

### 4. 安全建议
- 生产环境中建议将AccessKey配置到环境变量
- 定期轮换AccessKey
- 监控异常发送行为

## 🔧 故障排除

### 常见错误及解决方案

1. **触发流控限制**
   ```
   错误: 触发号码天级流控Permits:40
   解决: 等待24小时后重试，或在阿里云控制台调整限制
   ```

2. **签名不存在**
   ```
   错误: 短信签名不存在
   解决: 检查签名是否审核通过，确认签名名称正确
   ```

3. **模板不存在**
   ```
   错误: 短信模板不存在
   解决: 检查模板CODE是否正确，确认模板审核状态
   ```

4. **网络请求失败**
   ```
   错误: 网络请求失败
   解决: 检查网络连接，确认服务器能访问阿里云API
   ```

## 📈 性能优化

### 建议优化项
1. 使用Redis缓存验证码，减少数据库压力
2. 异步发送短信，提高响应速度
3. 批量清理过期验证码记录
4. 监控发送成功率和失败原因

---

**集成完成时间**: 2025年8月15日  
**测试状态**: ✅ 通过  
**维护人员**: 系统管理员 